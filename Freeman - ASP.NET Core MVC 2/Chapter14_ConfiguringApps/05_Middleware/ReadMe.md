# Промежуточное программное обеспечение (Middleware) ASP.NET

В ASP.NET Core термин *промежуточное ПО* (`Middleware`) используется в отношении компонентов,
которые объединяются с целью формирования конвейера запросов.
Конвейер запросов организов ананалогично цепочке: когда поступает новый запрос, он передается
первому компоненту промежуточного ПО в цепочке.
Компонент инспектирует запрос и решает, обработать его и сгенерировать ответ или передать
следующему компоненту в цепочке.

Послетого как запрос обработан, ответ, который будет возвращен клиенту,
передается по цепочке обратно, что позволяет всем предшествующим компонентам инспектировать
или модифицировать его.

## Общие моменты в релизации Middleware
Middleware не реализуют какой-либо интерфейс и не наследуются от определенного базового класса.
Взамен они:
1. Определяют конструктор, принимающий объект `RequestDelegate`.
2. Метод `Invoke()`.

`RequestDelegate` - следующий компонент Middleware
`Invoke()` вызывается, когда ASP.NET получает HTTP-запрос.

Информация о запросе и ответе HTTP, который будет возвращен клиенту, предоставляется методу
`Invoke()` через аргумент `HttpContext`.

Компоненты промежуточного ПО получают запросы в порядке, в котором они были настроены в
`Startup.Configure()`.

## Middleware для генерации содержимого
Файл `Infrastructure/ContentMiddleware.cs`.

`Invoke()` инспектирует HTTP-запрос и проверяет его на URL вида `/content`.
Если да, то отправляется ответ, если нет, то запрос перенаправляется следующему `Middleware`.

Middleware для генерации содержимого добавляется в `Startup/Configure()`:
```cs
app.UseMiddleware<ContentMiddleware>();
```

## Middleware для генерации содержимого, который использует сервис
Файл `Infrastructure/ContentMiddlewareWithService.cs`.
Добавляется в `Startup/Configure()`:
```cs
app.UseMiddleware<ContentMiddlewareWithService>();
```
Использует сервис `UptimeService`.

## Middleware для обхода
Перехватывают запросы до того, как они достигнут компонентов для генерации содержимого.
Часто это нужно для обхода конвейера для ускорения производительности.

Пример см. в файле `Infrastructure/ShortCircuitMiddleware.cs`.

Данный middleware проверяет заголовок `User-Agent` запроса, который применяется для индентификации
броузера (не использовать в реальных проектах).

Если `User-Agent` содержит `edge`, то обработка запроса заканчивается и клиенту посылается
код состояния 403 (403 - Forbidden).

## Middleware для редактирования запросов
Изменяет запросы перед тем, как они достигнут других компонентов, находящихся далее по цепочке.
Применяется преимущественно:
* Для интеграции с платформой.
* Для облегчения обработки запросов последующими компонентами.

Пример см. в файле: `Infrastructure/BrowserTypeMiddleware.cs`.

Здесь испектируется заголовок `User-Agent`, ищется "edge".
Далее используется словарь `Items` объекта `HttpContext` для передачи данных между компонентами:
результат поиска в заголовке сохраняется с ключом `EdgeBrowser`.

Далее, в файле `Infrastructure/ContentMiddlewareForItems.cs` при URL `/browser` проверяется
наличие ключа `EdgeBrowser` в `HttpContext.Items` и на основании его значения отправляется
соответствующий ответ.

## Middleware для редактирования ответов
Изменяет ответы, генерируемые другими компонентами в конвейере.
Это полезно для:
* Регистрации в журнале деталей запросов и их ответов.
* Обработки ошибок.

Пример см. в файле: `Infrastructure/ErrorMiddleware.cs`.

Компонент не заинтересован в запросе до тех пор, пока запрос не пройдет свой путь через конвейер
и не будет сгенерирован ответ.

В примере, если кодом состояния является 403 или 404, тогда компонент добавляет к ответу
описательное сообщение.
